<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake</title>
    <!-- Carga de Tailwind CSS para estilos de la página -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el canvas y el cuerpo */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Fondo gris claro */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        #gameCanvas {
            border: 4px solid #333; /* Borde oscuro para enmarcar el juego */
            background-color: white; /* Fondo blanco requerido */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            touch-action: none; /* Previene el comportamiento de desplazamiento táctil por defecto */
        }
        /* Modal de Tienda y Mensajes */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .message-box {
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px 50px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.9);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .control-button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #e53e3e; /* Rojo */
            color: white;
            font-weight: bold;
            border-radius: 8px;
            transition: transform 0.1s;
            box-shadow: 0 4px 0 #9b2c2c;
        }
        .control-button:active {
            transform: scale(0.95) translateY(4px);
            box-shadow: none;
        }
        .shop-item {
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }
        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }
        .shop-item.selected {
            border-color: #00ff00; /* Borde neón para el seleccionado */
            box-shadow: 0 0 10px #00ff00;
        }
    </style>
</head>
<body>

    <div id="gameContainer" class="flex flex-col items-center p-6 space-y-6">
        <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">
            Snake
        </h1>

        <!-- Marcadores y Tienda -->
        <div class="flex justify-between items-center w-full max-w-sm px-4 space-x-4">
            <div class="flex flex-col items-start">
                <div id="scoreDisplay" class="text-2xl font-semibold text-gray-700">Puntuación: 0</div>
                <div id="highScoreDisplay" class="text-lg font-semibold text-red-600">Mejor: 0</div>
            </div>
            
            <div class="flex flex-col items-center">
                <div id="coinsDisplay" class="text-3xl font-bold text-yellow-500 flex items-center">
                    <span class="mr-2">0</span>
                    <svg class="w-6 h-6 fill-current text-yellow-500" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15.5v-2c0-.55.45-1 1-1s1 .45 1 1v2c0 .55-.45 1-1 1s-1-.45-1-1zm3.5-3.5c-.32.44-.76.76-1.26.96-.5.2-1.07.3-1.68.3-.61 0-1.18-.1-1.68-.3-.5-.2-.94-.52-1.26-.96-.44-.6-.66-1.3-.66-2.1v-2h-.5c-.55 0-1-.45-1-1s.45-1 1-1h.5v-1c0-.55.45-1 1-1s1 .45 1 1v1h3v-1c0-.55.45-1 1-1s1 .45 1 1v1h.5c.55 0 1 .45 1 1s-.45 1-1 1h-.5v2c0 .8-.22 1.5-.66 2.1z"/>
                    </svg>
                </div>
                <button id="shopBtn" class="bg-gray-700 text-white text-sm px-4 py-1 rounded-full mt-1 hover:bg-gray-800 transition">
                    Tienda
                </button>
            </div>
        </div>

        <!-- Canvas del Juego -->
        <canvas id="gameCanvas" width="400" height="400" class="max-w-full h-auto"></canvas>

        <!-- Velocidad (Oculto en móvil) -->
        <div id="speedDisplay" class="text-lg font-medium text-gray-500 hidden sm:block">Velocidad: 200ms</div>
        <div class="text-sm font-semibold text-gray-500">Presiona ENTER para Pausar / Tienda | ESPACIO para Iniciar/Reanudar</div>

        <!-- Controles para móvil -->
        <div id="controls" class="w-full max-w-sm flex flex-col items-center mt-4 md:hidden">
            <div class="flex justify-center">
                <button id="upBtn" class="control-button w-1/3">ARRIBA</button>
            </div>
            <div class="flex justify-between w-full">
                <button id="leftBtn" class="control-button w-1/3">IZQUIERDA</button>
                <button id="rightBtn" class="control-button w-1/3">DERECHA</button>
            </div>
            <div class="flex justify-center">
                <button id="downBtn" class="control-button w-1/3">ABAJO</button>
            </div>
            <p class="text-sm text-gray-500 mt-2">Usa las teclas de flecha o W/A/S/D en escritorio.</p>
        </div>
    </div>

    <!-- Modal de Mensajes de Estado del Juego (Game Over / Inicio / Pausa) -->
    <div id="messageModal" class="modal hidden">
        <div id="messageBox" class="message-box">
            <h2 id="messageTitle" class="text-3xl font-bold mb-4 text-red-400">¡Juego Terminado!</h2>
            <p id="messageScore" class="text-xl mb-3">Puntuación: 0</p>
            <p id="messageHighscore" class="text-xl mb-6 text-yellow-400">Mejor Puntuación: 0</p>
            <!-- BOTÓN DE INICIAR JUEGO / VOLVER A JUGAR -->
            <button id="startGameBtn" class="bg-white text-gray-900 px-6 py-3 font-bold rounded-full hover:bg-red-200 transition">
                Iniciar Juego
            </button>
        </div>
    </div>

    <!-- Modal de la Tienda -->
    <div id="shopModal" class="modal hidden">
        <div class="message-box w-11/12 md:w-2/3 lg:w-1/2">
            <h2 class="text-4xl font-extrabold mb-4 text-green-400">Tienda de Skins</h2>
            <div id="shopCoinsDisplay" class="text-3xl font-bold text-yellow-500 mb-6 flex items-center justify-center">
                Coins: <span class="ml-2">0</span>
            </div>

            <h3 class="text-2xl font-semibold mb-3 mt-4 text-red-500">Skins de Serpiente</h3>
            <div id="snakeSkinsContainer" class="grid grid-cols-2 gap-4 mb-8">
                <!-- Los skins de serpiente se inyectarán aquí -->
            </div>
            
            <h3 class="2xl font-semibold mb-3 mt-4 text-green-500">Skins de Lata (Comida)</h3>
            <div id="foodSkinsContainer" class="grid grid-cols-2 gap-4 mb-8">
                <!-- Los skins de lata se inyectarán aquí -->
            </div>

            <button id="closeShopBtn" class="bg-red-600 text-white px-6 py-3 font-bold rounded-full hover:bg-red-700 transition">
                Cerrar Tienda
            </button>
        </div>
    </div>

    <script type="module">
        // --- CONFIGURACIÓN DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variables globales del entorno Canvas (MANDATORIO USAR)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Variables de Firebase
        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // --- CONSTANTES Y CONFIGURACIÓN DEL JUEGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const coinsDisplay = document.getElementById('coinsDisplay').querySelector('span');
        const messageModal = document.getElementById('messageModal');
        const shopModal = document.getElementById('shopModal');
        const shopCoinsDisplay = document.getElementById('shopCoinsDisplay').querySelector('span');
        const messageTitle = document.getElementById('messageTitle');
        const messageScore = document.getElementById('messageScore');
        const messageHighscore = document.getElementById('messageHighscore');
        const startGameBtn = document.getElementById('startGameBtn'); 
        const shopBtn = document.getElementById('shopBtn');
        const closeShopBtn = document.getElementById('closeShopBtn');

        const GRID_SIZE = 20; 
        const TILE_SIZE = canvas.width / GRID_SIZE; 
        const INITIAL_GAME_SPEED = 200; 
        const GAME_PROFILE_PATH = (uid) => `artifacts/${appId}/users/${uid}/gameData/snake_profile`;

        // --- DATOS DEL JUEGO (Colores por defecto si no hay Firebase)
        let SNAKE_HEAD_COLOR = '#000000'; 
        let SNAKE_BODY_COLOR = '#E04A45'; 
        let LOGO_COLOR = '#00ff00';
        const BACKGROUND_COLOR = '#ffffff'; 
        
        // Colores de la Lata Monster (Negro y Neón)
        const CAN_BODY_COLOR = '#111111';
        const CAN_HIGHLIGHT_COLOR = '#333333'; 

        // --- TIENDA DE SKINS ---
        const SHOP_ITEMS = {
            snake: [
                { id: 'default', name: 'Rojo y Negro', body: '#E04A45', head: '#000000', price: 0, isOwned: true },
                { id: 'blue_neon', name: 'Azul Neón', body: '#3B82F6', head: '#1E40AF', price: 10, isOwned: false },
                { id: 'purple_toxic', name: 'Púrpura Tóxico', body: '#8B5CF6', head: '#4C1D95', price: 25, isOwned: false },
                { id: 'gold_rush', name: 'Dorado Lujo', body: '#FFD700', head: '#DAA520', price: 50, isOwned: false },
            ],
            food: [
                { id: 'default', name: 'Monster Verde', color: '#00ff00', price: 0, isOwned: true },
                { id: 'red_bull', name: 'Lata Roja (Fuego)', color: '#FF4500', price: 15, isOwned: false },
                { id: 'gold', name: 'Lata Dorada', color: '#FFD700', price: 30, isOwned: false },
            ]
        };

        // --- VARIABLES DEL JUEGO ---
        let snake = [];
        let food = {};
        let direction = { x: TILE_SIZE, y: 0 }; 
        let nextDirection = { x: TILE_SIZE, y: 0 };
        let score = 0;
        let gameInterval;
        let isGameOver = true;
        let isPaused = false; // Nueva variable de estado de pausa
        let gameSpeed = INITIAL_GAME_SPEED;
        
        // Variables persistentes (se inicializan con los valores por defecto del perfil)
        let profile = {
            highScore: 0,
            coins: 0,
            selectedSnakeId: 'default',
            selectedFoodId: 'default',
            ownedSnakeIds: ['default'],
            ownedFoodIds: ['default']
        };

        // --- GESTIÓN DE FIREBASE Y DATOS DE PERFIL ---

        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'anonymous-user';
                isAuthReady = true;

                // Empezar a escuchar cambios en el perfil
                listenToUserProfile();
                
            } catch (error) {
                console.error("Error al configurar Firebase:", error);
            }
        }

        function listenToUserProfile() {
            if (!isAuthReady || !userId) return;

            const profileRef = doc(db, GAME_PROFILE_PATH(userId));
            
            onSnapshot(profileRef, (docSnap) => {
                if (docSnap.exists()) {
                    // Cargar perfil existente
                    const data = docSnap.data();
                    profile = {
                        highScore: data.highScore || 0,
                        coins: data.coins || 0,
                        selectedSnakeId: data.selectedSnakeId || 'default',
                        selectedFoodId: data.selectedFoodId || 'default',
                        // Asegurar que las listas de propiedad son arrays válidos
                        ownedSnakeIds: Array.isArray(data.ownedSnakeIds) ? data.ownedSnakeIds : ['default'],
                        ownedFoodIds: Array.isArray(data.ownedFoodIds) ? data.ownedFoodIds : ['default']
                    };
                } else {
                    // Crear perfil inicial si no existe
                    saveUserProfile();
                }
                updateUIFromProfile();
            }, (error) => {
                console.error("Error al escuchar el perfil:", error);
            });
        }

        async function saveUserProfile(dataToUpdate = {}) {
            if (!isAuthReady || !userId) return;

            const profileRef = doc(db, GAME_PROFILE_PATH(userId));
            
            try {
                // Combina los datos actuales del perfil con las actualizaciones
                const newProfileData = { ...profile, ...dataToUpdate };
                
                await setDoc(profileRef, {
                    highScore: newProfileData.highScore,
                    coins: newProfileData.coins,
                    selectedSnakeId: newProfileData.selectedSnakeId,
                    selectedFoodId: newProfileData.selectedFoodId,
                    ownedSnakeIds: newProfileData.ownedSnakeIds,
                    ownedFoodIds: newProfileData.ownedFoodIds
                }, { merge: true });

                profile = newProfileData; // Actualizar el estado local después del guardado exitoso
                // No llamamos updateUIFromProfile() aquí, el onSnapshot lo hará por nosotros.
            } catch (e) {
                console.error("Error al guardar el perfil:", e);
            }
        }

        function updateUIFromProfile() {
            highScoreDisplay.textContent = `Mejor: ${profile.highScore}`;
            coinsDisplay.textContent = profile.coins;
            shopCoinsDisplay.textContent = profile.coins;
            
            // Aplicar skins
            const selectedSnake = SHOP_ITEMS.snake.find(s => s.id === profile.selectedSnakeId);
            const selectedFood = SHOP_ITEMS.food.find(f => f.id === profile.selectedFoodId);

            if (selectedSnake) {
                SNAKE_HEAD_COLOR = selectedSnake.head;
                SNAKE_BODY_COLOR = selectedSnake.body;
            }
            if (selectedFood) {
                LOGO_COLOR = selectedFood.color;
            }
            
            drawGame(); // Redibujar el juego con el nuevo skin
            renderShop(); // Actualizar la tienda
        }

        // --- LÓGICA DE TIENDA ---

        function renderShop() {
            const snakeSkinsContainer = document.getElementById('snakeSkinsContainer');
            const foodSkinsContainer = document.getElementById('foodSkinsContainer');
            
            snakeSkinsContainer.innerHTML = '';
            foodSkinsContainer.innerHTML = '';

            SHOP_ITEMS.snake.forEach(item => {
                snakeSkinsContainer.appendChild(createShopItem('snake', item));
            });
            SHOP_ITEMS.food.forEach(item => {
                foodSkinsContainer.appendChild(createShopItem('food', item));
            });
        }

        function createShopItem(type, item) {
            // Revisar si es propiedad del usuario
            const isOwned = type === 'snake' ? profile.ownedSnakeIds.includes(item.id) : profile.ownedFoodIds.includes(item.id);
            const isSelected = type === 'snake' ? (profile.selectedSnakeId === item.id) : (profile.selectedFoodId === item.id);
            
            const div = document.createElement('div');
            // Usamos 'selected' para destacar el ítem activo
            div.className = `shop-item p-3 rounded-lg text-center ${isSelected ? 'selected' : 'bg-gray-800'}`;
            div.dataset.id = item.id;
            div.dataset.type = type;

            let colorPreview;
            if (type === 'snake') {
                // Preview de skin de serpiente (cabeza y cuerpo)
                colorPreview = `<div class="w-12 h-6 mx-auto mb-2 rounded-md" style="background-color: ${item.body}; border: 2px solid ${item.head}"></div>`;
            } else { // food
                // Preview de skin de lata (color del logo)
                colorPreview = `<div class="w-6 h-6 mx-auto mb-2 rounded-full" style="background-color: ${item.color}; border: 2px solid #111"></div>`;
            }

            let buttonText;
            if (isSelected) {
                buttonText = 'Equipado';
            } else if (isOwned) {
                buttonText = 'Equipar';
            } else {
                buttonText = `Comprar (${item.price} Coins)`;
            }

            div.innerHTML = `
                <p class="font-bold text-white mb-1">${item.name}</p>
                ${colorPreview}
                <button class="w-full text-sm font-semibold py-1 rounded-full mt-1 
                    ${isSelected ? 'bg-green-600 text-white' : isOwned ? 'bg-blue-500 text-white' : 'bg-yellow-500 text-gray-900'}">
                    ${buttonText}
                </button>
            `;

            div.addEventListener('click', () => handleShopAction(type, item, isOwned));
            return div;
        }

        function handleShopAction(type, item, isOwned) {
            const selectedKey = type === 'snake' ? 'selectedSnakeId' : 'selectedFoodId';
            const ownedKey = type === 'snake' ? 'ownedSnakeIds' : 'ownedFoodIds';

            if (isOwned) {
                // --- LÓGICA DE EQUIPAR ---
                if (profile[selectedKey] !== item.id) {
                    // Solo guarda si es diferente para evitar escrituras innecesarias
                    saveUserProfile({ [selectedKey]: item.id });
                }
            } else {
                // --- LÓGICA DE COMPRA ---
                if (profile.coins >= item.price) {
                    
                    // Asegurar que profile[ownedKey] es un array antes de intentar usar push
                    const currentOwnedIds = Array.isArray(profile[ownedKey]) ? profile[ownedKey] : ['default'];

                    const newCoins = profile.coins - item.price;
                    const newOwnedIds = [...currentOwnedIds, item.id];
                    
                    const updateData = { 
                        coins: newCoins, 
                        [ownedKey]: newOwnedIds,
                        [selectedKey]: item.id // Equipar automáticamente al comprar
                    };

                    saveUserProfile(updateData);
                    
                } else {
                    alertMessage('Coins Insuficientes', `Necesitas ${item.price - profile.coins} coins más para comprar ${item.name}.`, 'red');
                }
            }
        }
        
        function openShop() {
            // Solo pausamos si el juego está activo (no Game Over)
            if (!isGameOver) { 
                isPaused = true;
                clearInterval(gameInterval); // Detener el bucle de juego
            }

            shopModal.classList.remove('hidden');
            messageModal.classList.add('hidden');
            renderShop(); // Asegurarse de que la tienda se dibuje con el estado actual
        }

        function closeShop() {
            shopModal.classList.add('hidden');
            // Si el juego está en Game Over, regresamos al modal de mensaje de Game Over
            if (isGameOver) {
                messageModal.classList.remove('hidden');
            }
            // NOTA: Si está pausado (isPaused=true), el juego se reanuda con ESPACIO o una tecla de dirección.
            drawGame(); // Asegurar que el mensaje de pausa se dibuje si no es Game Over
        }


        // --- INICIALIZACIÓN Y FUNCIONES DEL JUEGO ---

        function initGame() {
            // Re-establecer el juego
            snake = [
                { x: 4 * TILE_SIZE, y: 10 * TILE_SIZE },
                { x: 3 * TILE_SIZE, y: 10 * TILE_SIZE },
                { x: 2 * TILE_SIZE, y: 10 * TILE_SIZE }
            ];
            direction = { x: TILE_SIZE, y: 0 };
            nextDirection = { x: TILE_SIZE, y: 0 };
            score = 0;
            gameSpeed = INITIAL_GAME_SPEED;
            isGameOver = false;
            isPaused = false; // Asegurar que no está pausado
            
            scoreDisplay.textContent = 'Puntuación: 0';
            messageModal.classList.add('hidden');
            shopModal.classList.add('hidden');
            
            placeFood();
            startGameLoop();
        }
        
        function startGameLoop() {
            clearInterval(gameInterval);
            if (!isPaused && !isGameOver) {
                gameInterval = setInterval(update, gameSpeed);
            }
        }

        // Dibuja la Lata de Monster (Más realista)
        function drawFood() {
            // 1. Dibujar el cuerpo de la lata (Degradado Negro)
            const gradient = ctx.createLinearGradient(food.x, food.y, food.x + TILE_SIZE, food.y + TILE_SIZE);
            gradient.addColorStop(0, CAN_HIGHLIGHT_COLOR);
            gradient.addColorStop(1, CAN_BODY_COLOR);
            ctx.fillStyle = gradient;
            ctx.fillRect(food.x, food.y, TILE_SIZE, TILE_SIZE);

            // 2. Dibujar el logo 'M' (Color Neón Seleccionado)
            ctx.fillStyle = LOGO_COLOR;
            const center = food.x + TILE_SIZE / 2;
            const w = TILE_SIZE * 0.5; // Ancho total

            ctx.beginPath();
            // Pata izquierda
            ctx.moveTo(center - w / 2, food.y + TILE_SIZE * 0.8); 
            // Punta izquierda superior
            ctx.lineTo(center - w / 3, food.y + TILE_SIZE * 0.2); 
            // Centro abajo
            ctx.lineTo(center, food.y + TILE_SIZE * 0.8); 
            // Punta derecha superior
            ctx.lineTo(center + w / 3, food.y + TILE_SIZE * 0.2); 
            // Pata derecha
            ctx.lineTo(center + w / 2, food.y + TILE_SIZE * 0.8); 
            
            ctx.fill();
        }

        // Dibuja la serpiente (cabeza y cuerpo con colores seleccionados)
        function drawSnake() {
            // Dibujar el cuerpo (color seleccionado)
            for (let i = 1; i < snake.length; i++) {
                ctx.fillStyle = SNAKE_BODY_COLOR;
                ctx.fillRect(snake[i].x, snake[i].y, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = BACKGROUND_COLOR; // Espacio blanco entre segmentos
                ctx.strokeRect(snake[i].x, snake[i].y, TILE_SIZE, TILE_SIZE);
            }

            // Dibujar la cabeza (color seleccionado)
            const head = snake[0];
            ctx.fillStyle = SNAKE_HEAD_COLOR;
            ctx.beginPath();
            ctx.arc(head.x + TILE_SIZE / 2, head.y + TILE_SIZE / 2, TILE_SIZE / 2, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Dibuja un mensaje de PAUSA en el canvas
        function drawPauseMessage() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.4)'; // Fondo semitransparente
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 48px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('PAUSADO', canvas.width / 2, canvas.height / 2 - 30);
            
            ctx.font = '24px Inter';
            ctx.fillText('Presiona ESPACIO o cualquier dirección para continuar', canvas.width / 2, canvas.height / 2 + 30);
        }


        function drawGame() {
            ctx.fillStyle = BACKGROUND_COLOR;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (food.x !== undefined) drawFood(); // Asegurarse de que la comida exista
            if (snake.length > 0) drawSnake(); // Asegurarse de que la serpiente exista
            
            if (isPaused && !isGameOver && shopModal.classList.contains('hidden')) {
                drawPauseMessage();
            }
        }

        function placeFood() {
            let newFood;
            do {
                newFood = {
                    x: Math.floor(Math.random() * GRID_SIZE) * TILE_SIZE,
                    y: Math.floor(Math.random() * GRID_SIZE) * TILE_SIZE
                };
            } while (isFoodOnSnake(newFood));

            food = newFood;
        }

        function isFoodOnSnake(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }

        function update() {
            if (isGameOver || isPaused) return; // Evitar la actualización si está pausado o terminado

            direction = nextDirection;

            const newHead = {
                x: snake[0].x + direction.x,
                y: snake[0].y + direction.y
            };

            // Chequear colisiones (Muros y Auto-colisión)
            if (
                newHead.x < 0 ||
                newHead.x >= canvas.width ||
                newHead.y < 0 ||
                newHead.y >= canvas.height ||
                checkSelfCollision(newHead)
            ) {
                gameOver();
                return;
            }

            snake.unshift(newHead);

            // Chequear si come la comida (Gana Coin)
            if (newHead.x === food.x && newHead.y === food.y) {
                score++;
                profile.coins++; // ¡Gana 1 Coin!
                scoreDisplay.textContent = `Puntuación: ${score}`;
                coinsDisplay.textContent = profile.coins;
                
                // Aumentar la velocidad
                if (score % 5 === 0 && gameSpeed > 50) {
                    gameSpeed -= 10;
                    startGameLoop(); 
                    document.getElementById('speedDisplay').textContent = `Velocidad: ${gameSpeed}ms`;
                }

                placeFood(); 
            } else {
                snake.pop();
            }

            drawGame();
        }

        function checkSelfCollision(head) {
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    return true;
                }
            }
            return false;
        }

        function gameOver() {
            isGameOver = true;
            isPaused = false; // Asegurar que el estado de pausa se limpia
            clearInterval(gameInterval);

            // Guardar y verificar HighScore
            let newHighScore = profile.highScore;
            let isNewRecord = false;

            if (score > profile.highScore) {
                newHighScore = score;
                isNewRecord = true;
            }

            // Guardar los datos en Firestore
            saveUserProfile({ highScore: newHighScore, coins: profile.coins });

            // Mostrar mensaje de fin de juego
            messageTitle.textContent = isNewRecord ? '¡NUEVO RÉCORD!' : '¡Juego Terminado!';
            messageScore.textContent = `Puntuación: ${score}`;
            messageHighscore.textContent = `Mejor Puntuación: ${newHighScore}`;
            startGameBtn.textContent = 'Volver a Jugar'; // Cambiar texto del botón
            messageModal.classList.remove('hidden');
        }
        
        // Función para mostrar mensajes de alerta sin usar alert()
        function alertMessage(title, message, color) {
            const tempBox = document.createElement('div');
            tempBox.className = 'message-box fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-4 text-center z-50 transition-opacity duration-300';
            tempBox.style.backgroundColor = color === 'red' ? 'rgba(185, 28, 28, 0.95)' : 'rgba(251, 191, 36, 0.95)';
            tempBox.innerHTML = `<h3 class="text-xl font-bold mb-2 text-white">${title}</h3><p class="text-white">${message}</p>`;
            document.body.appendChild(tempBox);

            setTimeout(() => {
                tempBox.style.opacity = '0';
                setTimeout(() => tempBox.remove(), 300);
            }, 2000);
        }

        // --- MANEJO DE ENTRADAS ---

        document.addEventListener('keydown', changeDirection);
        startGameBtn.addEventListener('click', initGame); 
        shopBtn.addEventListener('click', openShop);
        closeShopBtn.addEventListener('click', closeShop);

        // Controles táctiles
        document.getElementById('upBtn').addEventListener('click', () => setDirection(0, -TILE_SIZE));
        document.getElementById('downBtn').addEventListener('click', () => setDirection(0, TILE_SIZE));
        document.getElementById('leftBtn').addEventListener('click', () => setDirection(-TILE_SIZE, 0));
        document.getElementById('rightBtn').addEventListener('click', () => setDirection(TILE_SIZE, 0));

        function handleResumeOrInit() {
            // Caso 1: Juego Terminado -> Iniciar
            if (isGameOver) {
                initGame();
                return true; // Indicamos que la acción fue manejada
            }
            
            // Caso 2: Juego Pausado -> Reanudar
            if (isPaused) {
                isPaused = false;
                startGameLoop(); // Reanudar el bucle
                drawGame(); // Limpiar el mensaje de pausa
                return true;
            }

            return false; // No había nada que reanudar/iniciar
        }

        function setDirection(x, y) {
            if (handleResumeOrInit()) {
                 // Si se inició o reanudó, permitimos que la tecla de dirección se aplique.
            }
            
            // Solo cambiar dirección si el juego no está en Game Over o Pausa
            if (!isGameOver && !isPaused) {
                const isOppositeX = direction.x === -x;
                const isOppositeY = direction.y === -y;

                if (isOppositeX || isOppositeY) return;

                nextDirection = { x: x, y: y };
            }
        }

        function changeDirection(event) {
            
            const isShopOpen = !shopModal.classList.contains('hidden');
            const isEnterKey = event.key === 'Enter';
            const isSpaceKey = event.key === ' ';

            // --- Lógica de ENTER (Pausar / Abrir/Cerrar Tienda) ---
            if (isEnterKey) {
                event.preventDefault(); 

                if (isShopOpen) {
                    // Si la tienda está abierta, ENTER la cierra.
                    closeShop();
                    return;
                }

                if (isGameOver) {
                    // Si está en Game Over, ENTER inicia el juego (comportamiento de botón)
                    initGame();
                    return;
                }
                
                if (!isPaused) {
                    // Si está corriendo, ENTER pausa y abre la Tienda.
                    openShop();
                    return;
                }
            }

            // --- Lógica de ESPACIO (Iniciar / Reanudar) ---
            if (isSpaceKey) {
                event.preventDefault();
                // Si la tienda está abierta, ignoramos ESPACIO.
                if (isShopOpen) return;

                handleResumeOrInit();
                return;
            }

            // --- Lógica de Dirección (Movimiento / Reanudar si está Pausado) ---
            switch (event.key) {
                case 'ArrowUp': case 'w': 
                    event.preventDefault();
                    setDirection(0, -TILE_SIZE); 
                    break;
                case 'ArrowDown': case 's': 
                    event.preventDefault();
                    setDirection(0, TILE_SIZE); 
                    break;
                case 'ArrowLeft': case 'a': 
                    event.preventDefault();
                    setDirection(-TILE_SIZE, 0); 
                    break;
                case 'ArrowRight': case 'd': 
                    event.preventDefault();
                    setDirection(TILE_SIZE, 0); 
                    break;
            }
        }


        // --- INICIO AL CARGAR LA PÁGINA ---
        window.onload = function() {
            setupFirebase().then(() => {
                // Mostrar mensaje inicial solo después de cargar el perfil
                messageTitle.textContent = '¡Bienvenido a Snake!';
                messageScore.textContent = '¡Colecciona latas Monster y obtén Coins!';
                messageHighscore.textContent = `Mejor Puntuación: ${profile.highScore}`;
                startGameBtn.textContent = 'Iniciar Juego'; // Asegurar texto inicial
                messageModal.classList.remove('hidden');
                
                isGameOver = true;
                drawGame();
            });
        };

    </script>
</body>
</html>
